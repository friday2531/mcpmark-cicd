name: Deployment Status Workflow

on:
  push:
    branches:
      - main

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create_issue.outputs.result }}
      previous_sha: ${{ steps.prev_sha.outputs.previous_sha }}
      package_version: ${{ steps.pkg_version.outputs.package_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          else
            echo "package.json not found, skipping install"
          fi

      - name: Lint
        continue-on-error: true
        run: |
          if [ -f package.json ]; then
            npm run -s lint || echo "No lint script or lint failed; continuing"
          else
            echo "package.json not found, skipping lint"
          fi

      - name: Test
        continue-on-error: true
        run: |
          if [ -f package.json ]; then
            npm test || echo "No test script or tests failed; continuing"
          else
            echo "package.json not found, skipping tests"
          fi

      - name: Capture previous commit SHA
        id: prev_sha
        run: |
          set -e
          git fetch --depth=2 origin ${{ github.ref }} || true
          PREV=$(git rev-parse HEAD^ 2>/dev/null || echo "unknown")
          echo "previous_sha=$PREV" >> "$GITHUB_OUTPUT"

      - name: Capture package version
        id: pkg_version
        run: |
          VERSION=$(node -e "try{console.log(require('./package.json').version || '0.0.0')}catch(e){console.log('0.0.0')}" || echo "0.0.0")
          echo "package_version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create deployment tracking issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${context.sha}`,
              body: `Deployment tracking for commit ${context.sha}.\nPrevious commit: ${{ steps.prev_sha.outputs.previous_sha }}\nPackage version: ${{ steps.pkg_version.outputs.package_version }}`,
              labels: ['deployment', 'in-progress']
            });
            return issue.data.number;

      - name: Comment on deployment issue (pre-deployment)
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_issue.outputs.result }},
              body: 'Pre-deployment checks completed'
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    outputs:
      artifact_name: ${{ steps.vars.outputs.artifact_name }}
      checksum: ${{ steps.checksum.outputs.sha256 }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare variables
        id: vars
        run: |
          echo "artifact_name=rollback-package-${{ github.sha }}" >> "$GITHUB_OUTPUT"
          echo "current_sha=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          echo "previous_sha=${{ needs.pre-deployment.outputs.previous_sha }}" >> "$GITHUB_OUTPUT"
          echo "package_version=${{ needs.pre-deployment.outputs.package_version }}" >> "$GITHUB_OUTPUT"

      - name: Create rollback artifacts
        run: |
          set -euo pipefail
          mkdir -p rollback/backups
          # Backup configuration files if they exist
          [ -f package.json ] && cp package.json rollback/backups/package.json || echo "package.json not found"
          [ -f package-lock.json ] && cp package-lock.json rollback/backups/package-lock.json || echo "package-lock.json not found"
          if [ -f .env.example ]; then cp .env.example rollback/backups/.env.example; fi
          if [ -f .env.template ]; then cp .env.template rollback/backups/.env.template; fi
          if [ ! -f rollback/backups/.env.template ] && [ ! -f rollback/backups/.env.example ]; then
            echo "# Environment template" > rollback/backups/.env.template
          fi

          # Create rollback script with error handling
          cat > rollback/rollback.sh << 'EOS'
          #!/usr/bin/env bash
          set -euo pipefail
          trap 'echo "[ERROR] Rollback failed at line ${LINENO}" >&2' ERR

          PREV_SHA="${{ needs.pre-deployment.outputs.previous_sha }}"
          ARTIFACT_DIR="$(dirname "$0")"

          echo "Starting rollback..."
          echo "Target previous commit: ${PREV_SHA}"

          if ! command -v git >/dev/null 2>&1; then
            echo "git is required for rollback" >&2
            exit 1
          fi

          # Restore configuration backups
          if [ -d "$ARTIFACT_DIR/backups" ]; then
            cp -f "$ARTIFACT_DIR/backups/package.json" . 2>/dev/null || true
            cp -f "$ARTIFACT_DIR/backups/package-lock.json" . 2>/dev/null || true
            echo "Configuration files restored (if available)."
          fi

          # Checkout previous commit (detached HEAD)
          git fetch --all || true
          git checkout "${PREV_SHA}" || {
            echo "Failed to checkout previous commit ${PREV_SHA}" >&2
            exit 1
          }

          # Reinstall dependencies to ensure compatibility
          if [ -f package-lock.json ]; then
            npm ci || npm install
          fi

          echo "Rollback complete. Repository is now at ${PREV_SHA}."
          EOS
          chmod +x rollback/rollback.sh

          # Dependency verification script
          cat > rollback/verify-deps.sh << 'EOS'
          #!/usr/bin/env bash
          set -euo pipefail
          echo "Verifying dependency compatibility..."
          if [ -f package.json ]; then
            node -e "const fs=require('fs');const pkg=require('./package.json');console.log('Name:',pkg.name||'unknown');console.log('Version:',pkg.version||'0.0.0');console.log('Dependencies:',Object.keys(pkg.dependencies||{}).length)" || true
            npm ls --depth=0 || true
          else
            echo "package.json not found"
          fi
          echo "Dependency verification finished."
          EOS
          chmod +x rollback/verify-deps.sh

          # Rollback documentation
          cat > rollback/ROLLBACK.md << 'EOS'
          # Rollback Plan

          This document provides step-by-step instructions to perform a rollback.

          ## Steps
          1. Download the rollback artifact for the target commit.
          2. Extract the archive.
          3. Run the rollback script.
          4. Verify dependencies using the verification script.
          5. Validate application status.

          ## Commands
          ```bash
          tar -xzf rollback-package-${{ github.sha }}.tar.gz
          bash rollback/rollback.sh
          bash rollback/verify-deps.sh
          ```

          ## Notes
          - Ensure you have git and Node.js installed.
          - The script attempts to restore configuration backups and checkout the previous commit.
          - Review changes before pushing any rollback state.
          EOS

          # Package the rollback folder
          tar -czf "rollback-package-${{ github.sha }}.tar.gz" rollback

      - name: Generate SHA256 checksum
        id: checksum
        run: |
          SUM=$(sha256sum "rollback-package-${{ github.sha }}.tar.gz" | awk '{print $1}')
          echo "SHA256=${SUM}" > rollback/checksum.txt
          echo "sha256=$SUM" >> "$GITHUB_OUTPUT"

      - name: Upload rollback artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.artifact_name }}
          path: |
            rollback-package-${{ github.sha }}.tar.gz
            rollback/checksum.txt
          retention-days: 30

      - name: Post rollback plan comment on deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number(`${{ needs.pre-deployment.outputs.issue_number }}`);
            const previousSha = `${{ needs.pre-deployment.outputs.previous_sha }}`;
            const currentSha = `${{ github.sha }}`;
            const pkgVersion = `${{ needs.pre-deployment.outputs.package_version }}`;
            const artifactName = `rollback-package-${currentSha}`;
            const checksum = `${{ steps.checksum.outputs.sha256 }}`;

            const body = [
              `# ðŸ”„ Rollback Plan Ready`,
              `Previous Commit: ${previousSha}`,
              `Current Commit: ${currentSha}`,
              `Package Version: ${pkgVersion}`,
              `Artifact: ${artifactName}`,
              ``,
              `âœ… Rollback script created`,
              `âœ… Configuration backups prepared`,
              `âœ… Dependency verification script ready`,
              `âœ… Rollback documentation written`,
              `âœ… Compressed rollback package created`,
              ``,
              `Quick rollback command:`,
              '```bash',
              `tar -xzf ${artifactName}.tar.gz`,
              `bash rollback/rollback.sh`,
              '```',
              ``,
              `Rollback script created: true`,
              `Configuration backup: true`,
              `SHA256: ${checksum}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: rollback-preparation
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Remove in-progress label and add completed label
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number(`${{ needs.pre-deployment.outputs.issue_number }}`);
            // Remove in-progress if exists
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'in-progress'
              });
            } catch (e) {
              // Ignore if label not present
            }
            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['completed']
            });

      - name: Download rollback artifact for verification
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.rollback-preparation.outputs.artifact_name }}
          path: downloaded

      - name: Verify checksum
        run: |
          FILE="downloaded/${{ needs.rollback-preparation.outputs.artifact_name }}.tar.gz"
          EXPECTED="${{ needs.rollback-preparation.outputs.checksum }}"
          ACTUAL=$(sha256sum "$FILE" | awk '{print $1}')
          echo "Expected: $EXPECTED"
          echo "Actual:   $ACTUAL"
          if [ "$EXPECTED" != "$ACTUAL" ]; then
            echo "Checksum mismatch" >&2
            exit 1
          else
            echo "Checksum verified"
          fi

      - name: Finalize deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number(`${{ needs.pre-deployment.outputs.issue_number }}`);
            const artifactName = `${{ needs.rollback-preparation.outputs.artifact_name }}`;
            const checksum = `${{ needs.rollback-preparation.outputs.checksum }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `Deployment Completed Successfully. Artifact: ${artifactName}.tar.gz (SHA256: ${checksum})`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
